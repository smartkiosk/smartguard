#!/usr/bin/env ruby

require 'smartguard'
require 'dante'

runner = Dante::Runner.new('smartguard')
runner.description = "Smartkiosk services control daemon"

runner.with_options do |opts|
  options[:port] = 10000
  options[:development] = false

  opts.on("-a", "--app APPLICATION", String, "Application to use") do |x|
    options[:application] = x
  end
  opts.on("-x", "--path PATH", String, "Path to application") do |x|
    options[:path] = x
  end

  opts.on("-p", "--port PORT", Integer, "Port to run DRB (default: #{options[:port]})") do |x|
    options[:port] = x
  end

  opts.on("-v", "--version", "Output version") do |x|
    options[:version] = x
  end

  opts.on("-d", "--development", "Run in development environment") do |x|
    options[:development] = x
  end
end

runner.execute do |opts|
  abort "Smartguard version: #{Smartguard::VERSION}" if opts[:version]

  abort "You should specify application (--app)" if opts[:application].blank?

  if opts[:path].blank?
    if opts[:development]
      opts[:path] = Dir.getwd
    else
      abort "You should specify application path (--path)" if opts[:path].blank?
    end
  end

  application = Smartguard::Applications.const_get(opts[:application].camelize) rescue nil

  abort "Application `#{opts[:application]}` not supported" if application.nil?

  if opts[:development]
    Smartguard.environment = :development
  else
    Smartguard.environment = :production
  end

  application = application.new(opts[:path])
  DRb.start_service("druby://localhost:#{opts[:port]}", application)
  application.start_services
  DRb.thread.join
end
